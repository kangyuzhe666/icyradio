#ifndef __SI5351_H__
#define __SI5351_H__

#include <em_device.h>
#include <stdlib.h>
#include "systick.h"
#include "atomic.h"
#include "gpio.h"
#include "i2c.h"

#define SI5351_I2C_ADDR 0x60

// Registers
#define SI5351_REG_STATUS                 0x00
#define SI5351_REG_IRQ_FLAGS              0x01
#define SI5351_REG_IRQ_MASK               0x02
#define SI5351_REG_CLK_EN                 0x03
#define SI5351_REG_OEB_MASK               0x09
#define SI5351_REG_PLL_SRC                0x0F
#define SI5351_REG_CLKn_CFG(i)            (0x10 + (i))
#define SI5351_REG_CLK_DIS_0              0x18
#define SI5351_REG_CLK_DIS_1              0x19
#define SI5351_REG_CLKn_PHOFF(i)          (0xA5 + (i))
#define SI5351_REG_PLL_RST                0xB1
#define SI5351_REG_XTAL_CL                0xB7
#define SI5351_REG_FANOUT_EN              0xBB

// SI5351_REG_STATUS
#define SI5351_REG_STATUS_SYS_INIT  0x80
#define SI5351_REG_STATUS_LOL_B     0x40
#define SI5351_REG_STATUS_LOL_A     0x20
#define SI5351_REG_STATUS_LOS       0x10
#define SI5351_REG_STATUS_REVID     0x03

// SI5351_REG_IRQ_FLAGS
#define SI5351_REG_IRQ_FLAGS_SYS_INIT   0x80
#define SI5351_REG_IRQ_FLAGS_LOL_B      0x40
#define SI5351_REG_IRQ_FLAGS_LOL_A      0x20
#define SI5351_REG_IRQ_FLAGS_LOS        0x10

// SI5351_REG_IRQ_FLAGS
#define SI5351_REG_IRQ_MASK_SYS_INIT   0x80
#define SI5351_REG_IRQ_MASK_LOL_B      0x40
#define SI5351_REG_IRQ_MASK_LOL_A      0x20
#define SI5351_REG_IRQ_MASK_LOS        0x10

// SI5351_REG_PLL_SRC
#define SI5351_REG_PLL_SRC_CLKIN_DIV1   0x00
#define SI5351_REG_PLL_SRC_CLKIN_DIV2   0x40
#define SI5351_REG_PLL_SRC_CLKIN_DIV4   0x80
#define SI5351_REG_PLL_SRC_CLKIN_DIV8   0xC0
#define SI5351_REG_PLL_SRC_SRCB_XTAL    0x00
#define SI5351_REG_PLL_SRC_SRCB_CLKIN   0x08
#define SI5351_REG_PLL_SRC_SRCA_XTAL    0x00
#define SI5351_REG_PLL_SRC_SRCA_CLKIN   0x04

// SI5351_REG_CLKn_CFG
#define SI5351_REG_CLKn_CFG_POWER_UP    0x00
#define SI5351_REG_CLKn_CFG_POWER_DOWN  0x80
#define SI5351_REG_CLKn_CFG_MS_FRAC     0x00
#define SI5351_REG_CLKn_CFG_MS_INT      0x40
#define SI5351_REG_CLKn_CFG_MS_SRC_PLLA 0x00
#define SI5351_REG_CLKn_CFG_MS_SRC_PLLB 0x20
#define SI5351_REG_CLKn_CFG_CLK_INV     0x10
#define SI5351_REG_CLKn_CFG_SRC_XTAL    0x00
#define SI5351_REG_CLKn_CFG_SRC_CLKIN   0x04
#define SI5351_REG_CLKn_CFG_SRC_MSYNTH  0x0C
#define SI5351_REG_CLKn_CFG_IDRV_2MA    0x00
#define SI5351_REG_CLKn_CFG_IDRV_4MA    0x01
#define SI5351_REG_CLKn_CFG_IDRV_6MA    0x02
#define SI5351_REG_CLKn_CFG_IDRV_8MA    0x03

// SI5351_REG_CLK_DIS_0
#define SI5351_REG_CLK_DIS_0_DIS3_LOW   0x00
#define SI5351_REG_CLK_DIS_0_DIS3_HIGH  0x40
#define SI5351_REG_CLK_DIS_0_DIS3_HIZ   0x80
#define SI5351_REG_CLK_DIS_0_DIS3_NODIS 0xC0
#define SI5351_REG_CLK_DIS_0_DIS2_LOW   0x00
#define SI5351_REG_CLK_DIS_0_DIS2_HIGH  0x10
#define SI5351_REG_CLK_DIS_0_DIS2_HIZ   0x20
#define SI5351_REG_CLK_DIS_0_DIS2_NODIS 0x30
#define SI5351_REG_CLK_DIS_0_DIS1_LOW   0x00
#define SI5351_REG_CLK_DIS_0_DIS1_HIGH  0x04
#define SI5351_REG_CLK_DIS_0_DIS1_HIZ   0x08
#define SI5351_REG_CLK_DIS_0_DIS1_NODIS 0x0C
#define SI5351_REG_CLK_DIS_0_DIS0_LOW   0x00
#define SI5351_REG_CLK_DIS_0_DIS0_HIGH  0x01
#define SI5351_REG_CLK_DIS_0_DIS0_HIZ   0x02
#define SI5351_REG_CLK_DIS_0_DIS0_NODIS 0x03

// SI5351_REG_CLK_DIS_1
#define SI5351_REG_CLK_DIS_1_DIS7_LOW   0x00
#define SI5351_REG_CLK_DIS_1_DIS7_HIGH  0x40
#define SI5351_REG_CLK_DIS_1_DIS7_HIZ   0x80
#define SI5351_REG_CLK_DIS_1_DIS7_NODIS 0xC0
#define SI5351_REG_CLK_DIS_1_DIS6_LOW   0x00
#define SI5351_REG_CLK_DIS_1_DIS6_HIGH  0x10
#define SI5351_REG_CLK_DIS_1_DIS6_HIZ   0x20
#define SI5351_REG_CLK_DIS_1_DIS6_NODIS 0x30
#define SI5351_REG_CLK_DIS_1_DIS5_LOW   0x00
#define SI5351_REG_CLK_DIS_1_DIS5_HIGH  0x04
#define SI5351_REG_CLK_DIS_1_DIS5_HIZ   0x08
#define SI5351_REG_CLK_DIS_1_DIS5_NODIS 0x0C
#define SI5351_REG_CLK_DIS_1_DIS4_LOW   0x00
#define SI5351_REG_CLK_DIS_1_DIS4_HIGH  0x01
#define SI5351_REG_CLK_DIS_1_DIS4_HIZ   0x02
#define SI5351_REG_CLK_DIS_1_DIS4_NODIS 0x03

// SI5351_REG_PLL_RST
#define SI5351_REG_PLL_RST_PLLA_RESET   0x20
#define SI5351_REG_PLL_RST_PLLB_RESET   0x80

// SI5351_REG_XTAL_CL
#define SI5351_REG_XTAL_CL_6PF  0x40
#define SI5351_REG_XTAL_CL_8PF  0x80
#define SI5351_REG_XTAL_CL_10PF 0xC0

// SI5351_REG_FANOUT_EN
#define SI5351_REG_FANOUT_EN_CLKIN_EN   0x80
#define SI5351_REG_FANOUT_EN_XO_EN      0x40
#define SI5351_REG_FANOUT_EN_MS_EN      0x10

// Clock assignment
#define SI5351_FPGA_CLK3    0
#define SI5351_FPGA_CLK2    1
#define SI5351_FPGA_CLK1    2
#define SI5351_FPGA_CLK4    3
#define SI5351_SMC_MAIN_CLK 5
#define SI5351_DSP_MAIN_CLK 6


uint8_t si5351_init();
void si5351_isr();


#endif // __SI5351_H__